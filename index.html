<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeDogeAI Presale</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #000000;
            margin: 0;
            padding: 20px;
            color: #FFD700;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #000000;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        .logo-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .logo-container img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
        }
        button {
            background: #25D366;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
            transition: background 0.3s;
        }
        button:hover {
            background: #1DA851;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        .wallet-info {
            background-color: #000000;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            word-break: break-word;
            font-family: monospace;
            border: 1px solid #FFD700;
            color: #FFD700;
        }
        .info-box {
            background-color: #000000;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #FFD700;
            color: #FFD700;
            margin-top: 20px;
        }
        h1, h3, p, label {
            color: #FFD700;
        }
        .calculation-result {
            margin: 15px 0;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-container">
            <img src="logo.png" alt="FreeDogeAI Logo">
        </div>
        <h1>FreeDogeAI Presale</h1>
        <p>1 BNB = 120,000,000,000 FDAI</p>
        <button id="connectWalletBtn">ðŸ”— Connect with MetaMask</button>

        <div id="walletInfo" style="display: none;">
            <h3>Your Wallet</h3>
            <div class="wallet-info">
                <p><strong>Address:</strong> <span id="walletAddress"></span></p>
                <p><strong>BNB Balance:</strong> <span id="bnbBalance"></span></p>
            </div>
        </div>
        
        <div>
            <label for="bnbAmount"><strong>BNB Amount:</strong></label>
            <input type="number" id="bnbAmount" placeholder="0.1" step="0.01" min="0.01">
            
            <div class="calculation-result">
                <strong>You will receive:</strong> <span id="fdaiAmount">0</span> FDAI
            </div>
            
            <button id="buyBtn" disabled>ðŸš€ Buy FDAI Tokens</button>
        </div>
        
        <div class="info-box">
            <h3>Important Information</h3>
            <p>After your token purchase, your tokens will be reflected in your wallet within 24 hours. To view your token balance, you may need to manually add the token contract address using the 'Add Token' option in MetaMask.</p>
            
            <p><strong>FDAI Recipient Address:</strong> <span id="userTokenAddress"></span></p>
            
            <p><strong>NOTE:</strong> If FDAI tokens do not appear in your wallet after purchase, you can manually add the token using the following contract address:</p>
            <div class="wallet-info" style="background-color: #000000; border: 2px dashed #FFD700; color: #00FFCC; font-weight: bold; font-size: 16px; padding: 15px; border-radius: 10px; text-align: center;">
                0x8161698A74F2ea0035B9912ED60140893Ac0f39C
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            RECEIVE_WALLET: "0xd924e01c7d319c5b23708cd622bd1143cd4fb360",
            TOKENS_PER_BNB: 120000000000,
            BSC_CHAIN_ID: 56
        };

        // App state
        let web3;
        let userAddress = "";
        let awaitingSignature = false;

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            console.log("Page loaded, initializing...");

            // Setup event listeners
            const connectWalletBtn = document.getElementById('connectWalletBtn');
            if (connectWalletBtn) {
                connectWalletBtn.addEventListener('click', connectWallet);
            } else {
                console.error("ERROR: Connect Wallet button not found!");
            }

            const buyBtn = document.getElementById('buyBtn');
            if (buyBtn) {
                buyBtn.addEventListener('click', sendBNB);
            } else {
                console.error("ERROR: Buy button not found!");
            }

            const bnbAmountInput = document.getElementById('bnbAmount');
            if (bnbAmountInput) {
                bnbAmountInput.addEventListener('input', calculateFDAI);
            } else {
                console.error("ERROR: BNB Amount input not found!");
            }

            // Check if returning from MetaMask
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('signed') === 'true' && window.ethereum?.selectedAddress) {
                console.log("Returning from MetaMask, completing connection...");
                userAddress = window.ethereum.selectedAddress;
                web3 = new Web3(window.ethereum);
                updateWalletUI();
            }
        });

        // Wallet connection handler
        async function connectWallet() {
            console.log("Attempting to connect wallet...");

            // If on mobile, open MetaMask app
            if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                console.log("Mobile device detected, opening MetaMask app...");
                const currentUrl = window.location.href;
                // Add a query parameter to indicate signature request
                const redirectUrl = `${currentUrl}${currentUrl.includes('?') ? '&' : '?'}signed=true`;
                // Open MetaMask app
                window.location.href = `metamask://`;
                awaitingSignature = true;
                return;
            }

            // For desktop, proceed with signature in browser
            try {
                console.log("Requesting accounts from MetaMask...");
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];
                web3 = new Web3(window.ethereum);
                console.log("Accounts received, user address:", userAddress);

                // Request a signature to verify the user
                console.log("Requesting signature from user...");
                const message = `Welcome to FreeDogeAI!\n\nPlease sign this message to connect your wallet.\n\nWallet Address: ${userAddress}\nTimestamp: ${Date.now()}`;
                const signature = await window.ethereum.request({
                    method: 'personal_sign',
                    params: [message, userAddress]
                });
                console.log("Signature received:", signature);

                // Switch to BSC network
                try {
                    const chainId = await web3.eth.getChainId();
                    console.log("Current chain ID:", chainId);
                    if (chainId !== CONFIG.BSC_CHAIN_ID) {
                        console.log("Switching to BSC Mainnet...");
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x38' }] // BSC Mainnet
                        });
                        console.log("Switched to BSC Mainnet");
                    }
                } catch (error) {
                    console.error("Network switch failed:", error.message);
                }

                updateWalletUI();
            } catch (error) {
                console.error("Connection error:", error.message);
                alert("Failed to connect: " + error.message);
            }
        }

        // Update UI after connection
        function updateWalletUI() {
            console.log("Updating wallet UI...");
            const walletAddressElement = document.getElementById('walletAddress');
            const userTokenAddressElement = document.getElementById('userTokenAddress');
            const walletInfoElement = document.getElementById('walletInfo');
            const connectWalletBtn = document.getElementById('connectWalletBtn');
            const buyBtn = document.getElementById('buyBtn');

            if (!walletAddressElement || !userTokenAddressElement || !walletInfoElement || !connectWalletBtn || !buyBtn) {
                console.error("One or more UI elements not found!");
                return;
            }

            const shortAddress = `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
            walletAddressElement.textContent = shortAddress;
            userTokenAddressElement.textContent = shortAddress;

            walletInfoElement.style.display = 'block';
            connectWalletBtn.textContent = 'âœ… Connected';
            buyBtn.disabled = false;

            web3.eth.getBalance(userAddress).then(balance => {
                const bnbBalance = web3.utils.fromWei(balance, 'ether');
                document.getElementById('bnbBalance').textContent = `${parseFloat(bnbBalance).toFixed(6)} BNB`;
                console.log("BNB Balance updated:", document.getElementById('bnbBalance').textContent);
            }).catch(error => {
                console.error("Failed to fetch balance:", error.message);
            });
        }

        // Calculate FDAI tokens
        function calculateFDAI() {
            console.log("Calculating FDAI tokens...");
            const bnbAmountInput = document.getElementById('bnbAmount');
            const fdaiAmountElement = document.getElementById('fdaiAmount');

            if (!bnbAmountInput || !fdaiAmountElement) {
                console.error("BNB Amount or FDAI Amount element not found!");
                return;
            }

            const amount = parseFloat(bnbAmountInput.value) || 0;
            fdaiAmountElement.textContent = (amount * CONFIG.TOKENS_PER_BNB).toLocaleString();
            console.log("FDAI amount updated:", fdaiAmountElement.textContent);
        }

        // Send BNB transaction
        async function sendBNB() {
            console.log("Sending BNB transaction...");
            const bnbAmountInput = document.getElementById('bnbAmount');
            if (!bnbAmountInput) {
                console.error("BNB Amount input not found!");
                return;
            }

            const bnbAmount = parseFloat(bnbAmountInput.value);
            if (!bnbAmount || bnbAmount <= 0) {
                console.log("Invalid BNB amount entered:", bnbAmount);
                alert("Please enter a valid amount!");
                return;
            }

            if (!web3 || !userAddress) {
                console.error("Wallet not connected!");
                alert("Please connect your wallet first!");
                return;
            }

            try {
                const weiAmount = web3.utils.toWei(bnbAmount.toString(), 'ether');
                console.log("Transaction details - Amount in Wei:", weiAmount);

                const tx = {
                    from: userAddress,
                    to: CONFIG.RECEIVE_WALLET,
                    value: weiAmount,
                    gas: 300000,
                    gasPrice: await web3.eth.getGasPrice()
                };

                console.log("Sending transaction:", tx);
                const receipt = await web3.eth.sendTransaction(tx);
                console.log("Transaction successful, receipt:", receipt);

                alert(`âœ… ${bnbAmount} BNB successfully sent!\n\nYou will receive: ${(bnbAmount * CONFIG.TOKENS_PER_BNB).toLocaleString()} FDAI\nTX Hash: ${receipt.transactionHash}`);
            } catch (error) {
                console.error("Transaction failed:", error.message);
                alert("Transaction failed: " + (error.message || error));
            }
        }

        // Handle account changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                console.log("Accounts changed:", accounts);
                if (accounts.length > 0) {
                    userAddress = accounts[0];
                    web3 = new Web3(window.ethereum);
                    updateWalletUI();
                } else {
                    console.log("Disconnected from MetaMask");
                    const walletInfoElement = document.getElementById('walletInfo');
                    const connectWalletBtn = document.getElementById('connectWalletBtn');
                    const buyBtn = document.getElementById('buyBtn');

                    if (walletInfoElement && connectWalletBtn && buyBtn) {
                        walletInfoElement.style.display = 'none';
                        connectWalletBtn.textContent = 'ðŸ”— Connect with MetaMask';
                        buyBtn.disabled = true;
                        userAddress = "";
                        web3 = null;
                    }
                }
            });

            window.ethereum.on('chainChanged', () => {
                console.log("Chain changed, reloading page...");
                window.location.reload();
            });
        }
    </script>
</body>
                   </html>
